# 와줄래 생활수리 - 작업 매칭 시스템 설정 가이드

## 📋 **시스템 개요**

```
고객 → Google Form → Google Sheet
                         ↓
                    Apps Script
                         ↓
              기사들에게 이메일 발송
                         ↓
          www.wajulae.co.kr/request/REQ-xxx
                         ↓
                React 상세 페이지
                         ↓
              기사가 [수락하기] 클릭
                         ↓
               Apps Script WebApp
                         ↓
     Lock Service로 동시성 제어 (선착순 1명만)
                         ↓
            Google Sheet 업데이트
                         ↓
        모두에게 이메일 알림 발송
```

---

## 🔧 **1단계: Google Sheet 설정**

### **시트 구조**

#### **"고객요청" 시트**
| A | B | C | D | E | F | G | H | I | J | K | L | M | N | O | P |
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
| 요청ID | 타임스탬프 | 이름 | 연락처 | 거주형태 | 작업형태 | 사진/동영상 | 자세한증상 | 대략적주소 | 세부주소 | 희망날짜 | 원하는시간 | 추가요청 | 매칭상태 | 매칭시각 | 매칭된기사 |
| REQ-20250111-001 | 2025-01-11 14:30 | 홍길동 | 010-1234-5678 | 주택 | 보일러 | http://... | 물이 안나옴 | 서울시... | 102동 101호 | 2025-01-15 | 오전 11:11:00 | 빠르게 | 대기중 | | |

**중요:**
- A열: 요청ID (Apps Script가 자동 생성) ⚠️
- N열: 매칭상태 ("대기중", "매칭완료")
- O열: 매칭 시각 (자동 기록)
- P열: 매칭된 기사 (수락한 기사 이름)

#### **"기사목록" 시트**
| A | B |
|---|---|
| 이름 | 이메일 |
| 홍길동 | hong@example.com |
| 김철수 | kim@example.com |

---

## 🚀 **2단계: Google Apps Script 배포**

### **1. Apps Script 프로젝트 열기**

1. Google Sheet 열기
2. **확장 프로그램** → **Apps Script** 클릭
3. `google-apps-script.js` 파일의 코드를 모두 복사하여 붙여넣기

### **2. 트리거 설정**

```
왼쪽 메뉴 → 트리거 (시계 아이콘) → 트리거 추가

설정:
- 실행할 함수: onFormSubmit
- 이벤트 소스: 스프레드시트에서
- 이벤트 유형: 양식 제출 시
```

### **3. WebApp으로 배포**

```
1. 우측 상단 "배포" → "새 배포"
2. 유형 선택: "웹 앱"
3. 설정:
   - 설명: "와줄래 작업 매칭 API"
   - 다음 계정으로 실행: 나
   - 액세스 권한: 모든 사용자
4. "배포" 클릭
5. 웹 앱 URL 복사 (예: https://script.google.com/macros/s/AKfyc.../exec)
```

⚠️ **중요:** 이 URL을 React 코드에 입력해야 합니다!

---

## 💻 **3단계: React 프로젝트 설정**

### **WebApp URL 입력**

`src/pages/RequestDetailPage.jsx` 파일에서:

```javascript
// 18번째 줄 부근
const WEBAPP_URL = "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec";
```

👆 여기에 위에서 복사한 WebApp URL을 붙여넣으세요!

---

## 📧 **4단계: 이메일 발송 테스트**

### **1. Google Form 제출 테스트**

1. Google Form에서 테스트 요청 제출
2. Google Sheet에 데이터 확인
   - A열에 요청ID가 자동 생성되었는지
   - L열에 "대기중" 상태인지
3. 기사 이메일로 알림이 왔는지 확인

### **2. 수락 프로세스 테스트**

1. 이메일의 링크 클릭 (예: www.wajulae.co.kr/request/REQ-20250111-001)
2. 작업 상세 정보가 제대로 표시되는지 확인
3. 이름 입력 후 [수락하기] 클릭
4. Google Sheet 확인:
   - L열이 "매칭완료"로 변경되었는지
   - M열에 기사 이름이 기록되었는지
   - N열에 시각이 기록되었는지
5. 기사와 고객에게 매칭 완료 이메일이 왔는지 확인

### **3. 동시성 테스트**

1. 2명의 기사가 동시에 같은 링크 접속
2. 두 명 다 [수락하기] 클릭
3. **한 명만 성공**하고, 다른 한 명은 "이미 배정되었습니다" 메시지 확인

---

## 🔐 **5단계: 보안 강화 (선택)**

### **URL에 기사 토큰 추가**

현재는 누구나 링크를 열 수 있습니다. 보안을 강화하려면:

1. "기사목록" 시트에 "토큰" 열 추가
2. 각 기사마다 고유 토큰 생성 (예: UUID)
3. 이메일 발송 시 URL에 토큰 포함:
   ```
   www.wajulae.co.kr/request/REQ-xxx?token=ENGINEER_TOKEN
   ```
4. Apps Script에서 토큰 검증 로직 추가

---

## 📊 **시트 열 번호 참고**

```javascript
// Apps Script에서 사용하는 열 번호
A열 (1)  : 요청ID
B열 (2)  : 타임스탬프
C열 (3)  : 이름
D열 (4)  : 연락처
E열 (5)  : 거주 형태
F열 (6)  : 작업 형태
G열 (7)  : 사진/동영상
H열 (8)  : 자세한 증상
I열 (9)  : 대략적인 주소
J열 (10) : 세부 주소
K열 (11) : 작업 희망 날짜
L열 (12) : 원하는 작업 시간
M열 (13) : 추가 요청 사항
N열 (14) : 매칭 상태
O열 (15) : 매칭 시각
P열 (16) : 매칭된 기사
```

⚠️ **주의:** 위 열 번호는 현재 시트 구조에 맞춰져 있습니다!

---

## 🐛 **문제 해결**

### **이메일이 발송되지 않을 때**

1. Apps Script 실행 권한 확인
2. Google Sheet → Apps Script → 트리거 확인
3. Apps Script → 실행 로그 확인

### **요청 정보가 안 보일 때**

1. WebApp URL이 올바른지 확인
2. Chrome 개발자 도구 → Console 탭에서 에러 확인
3. Apps Script → 실행 로그에서 오류 확인

### **동시 수락 문제**

1. Apps Script에 Lock Service가 제대로 구현되어 있는지 확인
2. 테스트 시 5초 이내에 두 번 클릭해야 동시성 확인 가능

---

## 📱 **테스트 URL 예시**

```
로컬 테스트:
http://localhost:5173/request/REQ-20250111-001

프로덕션:
https://www.wajulae.co.kr/request/REQ-20250111-001
```

---

## 🎯 **완료 체크리스트**

- [ ] Google Sheet "고객요청" 시트 열 구조 확인
- [ ] Google Sheet "기사목록" 시트 이메일 입력
- [ ] Apps Script 코드 붙여넣기
- [ ] onFormSubmit 트리거 설정
- [ ] WebApp 배포 및 URL 복사
- [ ] React 코드에 WebApp URL 입력
- [ ] 빌드 및 배포
- [ ] 테스트 요청 제출
- [ ] 이메일 수신 확인
- [ ] 수락 프로세스 테스트
- [ ] 동시성 테스트

---

## 📞 **문의**

문제가 발생하면 Apps Script 실행 로그를 확인하세요!

```
Apps Script → 왼쪽 메뉴 → 실행 → 최근 실행 로그 확인
```

